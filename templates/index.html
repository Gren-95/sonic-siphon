<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Siphon</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .brand-icon-shadow {
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.5));
        }
        .dark .brand-icon-shadow {
            filter: drop-shadow(0 3px 6px rgba(255, 255, 255, 0.5));
        }
    </style>
</head>
<body class="min-h-screen transition-colors duration-300 bg-stone-50 dark:bg-gradient-to-br dark:from-stone-900 dark:via-stone-800 dark:to-stone-900 text-stone-900 dark:text-stone-50">
    <!-- Audio Player -->
    <div id="audioPlayer" class="hidden fixed bottom-4 right-4 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-lg p-3 shadow-xl max-w-xs z-50">
        <div class="flex justify-between items-center mb-2">
            <div class="text-xs font-semibold text-stone-900 dark:text-stone-50 truncate flex-1 mr-2" id="audioPlayerTitle">Now Playing</div>
            <button class="text-stone-500 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-50" onclick="closeAudioPlayer()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <audio id="audioElement" controls preload="metadata" class="w-full h-8"></audio>
    </div>

    <div class="h-screen flex flex-col p-4 gap-4 max-w-[1800px] mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-3">
                <svg width="40" height="40" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0 brand-icon-shadow">
                    <rect width="48" height="48" rx="12" fill="url(#gradient1)"/>
                    <path d="M24 8L34 14V20L24 26L14 20V14L24 8Z" fill="white" opacity="0.9"/>
                    <path d="M24 26L34 20V26L24 32L14 26V20L24 26Z" fill="white" opacity="0.7"/>
                    <path d="M24 32L34 26V32L24 38L14 32V26L24 32Z" fill="white" opacity="0.5"/>
                    <circle cx="24" cy="20" r="3" fill="#10b981"/>
                    <defs>
                        <linearGradient id="gradient1" x1="0" y1="0" x2="48" y2="48">
                            <stop offset="0%" stop-color="#1c1917"/>
                            <stop offset="100%" stop-color="#44403c"/>
                        </linearGradient>
                    </defs>
                </svg>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-stone-900 to-stone-700 dark:from-stone-100 dark:to-stone-300 bg-clip-text text-transparent">
                    Sonic Siphon
                </h1>
            </div>
            <button id="themeToggle" class="p-2 rounded-lg bg-stone-200 dark:bg-stone-700 hover:bg-stone-300 dark:hover:bg-stone-600 transition-colors">
                <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>

        <!-- Main Flex Container -->
        <div class="flex flex-col lg:flex-row gap-4 flex-1 min-h-0">
            <!-- 1. Download Form -->
            <div class="flex-shrink-0 lg:w-80 xl:w-96">
                <div class="bg-white dark:bg-stone-800/50 rounded-lg shadow-lg border border-stone-200 dark:border-stone-700 h-full flex flex-col">
                    <div class="p-4 border-b border-stone-200 dark:border-stone-700 bg-blue-100 dark:bg-blue-600/30 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path>
                        </svg>
                        <h2 class="font-semibold text-stone-900 dark:text-stone-50">Download</h2>
                    </div>
                    <div class="p-4 flex-1 flex flex-col">
                        <form id="downloadForm" class="flex flex-col h-full">
                            <div class="mb-3">
                                <label for="url" class="flex items-center gap-1.5 text-xs font-semibold text-stone-700 dark:text-stone-300 mb-1.5">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"></path>
                                    </svg>
                                    URL
                                </label>
                                <input 
                                    type="text" 
                                    id="url" 
                                    class="w-full px-3 py-2 border-2 border-stone-300 dark:border-stone-600 rounded-lg text-sm text-stone-900 dark:text-stone-50 bg-white dark:bg-stone-700 placeholder-stone-400 focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-300 focus:border-transparent"
                                    placeholder="https://youtube.com/watch?v=..."
                                    required
                                >
                            </div>

                            <div class="mb-4">
                                <label class="flex items-center gap-1.5 text-xs font-semibold text-stone-700 dark:text-stone-300 mb-1.5">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Playback Speed
                                </label>
                                <div class="grid grid-cols-6 gap-1.5">
                                    <label><input type="radio" name="speed" value="0.5" class="sr-only peer"><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">0.5x</div></label>
                                    <label><input type="radio" name="speed" value="1" class="sr-only peer" checked><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">1x</div></label>
                                    <label><input type="radio" name="speed" value="1.25" class="sr-only peer"><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">1.25x</div></label>
                                    <label><input type="radio" name="speed" value="1.5" class="sr-only peer"><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">1.5x</div></label>
                                    <label><input type="radio" name="speed" value="1.75" class="sr-only peer"><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">1.75x</div></label>
                                    <label><input type="radio" name="speed" value="2" class="sr-only peer"><div class="py-1.5 text-center border-2 border-stone-300 dark:border-stone-600 rounded cursor-pointer text-xs font-semibold text-stone-600 dark:text-stone-400 bg-white dark:bg-stone-700 peer-checked:bg-blue-600 peer-checked:dark:bg-blue-600 peer-checked:text-white peer-checked:border-transparent transition-all">2x</div></label>
                                </div>
                            </div>

                            <button type="submit" class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700 text-white rounded-lg text-sm font-semibold hover:shadow-lg transition-all disabled:opacity-50" id="downloadBtn">
                                Download
                            </button>

                            <!-- Preview Box -->
                            <div id="previewBox" class="hidden mt-4 p-3 rounded-lg border border-stone-300 dark:border-stone-600 bg-stone-50 dark:bg-stone-700/30">
                                <div id="previewContent"></div>
                            </div>

                            <div id="statusBox" class="hidden mt-4 p-3 rounded-lg border-l-4 border-stone-400">
                                <div class="font-semibold text-sm text-stone-900 dark:text-stone-50 mb-1" id="statusTitle"></div>
                                <div class="text-xs text-stone-700 dark:text-stone-300 mb-2" id="statusMessage"></div>
                                <div class="w-full h-1.5 bg-stone-200 dark:bg-stone-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-stone-900 to-stone-700 dark:from-stone-200 dark:to-stone-50 transition-all" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 2. Temp Files -->
            <div class="flex-1 min-w-0">
                <div class="bg-white dark:bg-stone-800/50 rounded-lg shadow-lg border border-stone-200 dark:border-stone-700 h-full flex flex-col">
                    <div class="p-4 border-b border-stone-200 dark:border-stone-700 bg-amber-100 dark:bg-amber-600/30 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"></path>
                            </svg>
                            <h2 class="font-semibold text-stone-900 dark:text-stone-50">Temp</h2>
                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-200 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300" id="tempFileCount">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="refreshTempBtn" class="p-1.5 rounded hover:bg-stone-200 dark:hover:bg-stone-600 transition-colors" title="Refresh">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path>
                                </svg>
                            </button>
                            <button id="moveToDoneBtn" class="hidden px-3 py-1.5 text-xs font-semibold bg-green-600 text-white rounded hover:bg-green-700 transition-all">
                                Move (<span id="selectedCount">0</span>) ‚Üí
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto" id="tempFileList">
                        <div class="text-center py-12 text-stone-500 dark:text-stone-400">
                            <div class="text-4xl mb-2">üìÇ</div>
                            <div class="text-sm">No files yet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Output Files -->
            <div class="flex-shrink-0 lg:w-80 xl:w-96">
                <div class="bg-white dark:bg-stone-800/50 rounded-lg shadow-lg border border-stone-200 dark:border-stone-700 h-full flex flex-col">
                    <div class="p-4 border-b border-stone-200 dark:border-stone-700 bg-green-100 dark:bg-green-600/30 flex items-center justify-between">
                        <button id="toggleOutputBtn" class="flex items-center gap-2 flex-1 lg:flex-none lg:cursor-default cursor-pointer hover:opacity-80 lg:hover:opacity-100 transition-opacity" onclick="toggleOutputSection()">
                            <svg class="w-4 h-4 transition-transform lg:hidden" id="outputChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                            </svg>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h2 class="font-semibold text-stone-900 dark:text-stone-50">Output</h2>
                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-green-200 dark:bg-green-900/50 text-green-800 dark:text-green-300" id="outputFileCount">0</span>
                        </button>
                        <div class="flex items-center gap-2">
                            <button id="refreshOutputBtn" class="p-1.5 rounded hover:bg-stone-200 dark:hover:bg-stone-600 transition-colors" title="Refresh">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto hidden lg:block" id="outputFileList">
                        <div class="text-center py-12 text-stone-500 dark:text-stone-400">
                            <div class="text-4xl mb-2">üìÅ</div>
                            <div class="text-sm">Empty</div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <script>
        const form = document.getElementById('downloadForm');
        const statusBox = document.getElementById('statusBox');
        const statusTitle = document.getElementById('statusTitle');
        const statusMessage = document.getElementById('statusMessage');
        const progressFill = document.getElementById('progressFill');
        const downloadBtn = document.getElementById('downloadBtn');
        const tempFileList = document.getElementById('tempFileList');
        const outputFileList = document.getElementById('outputFileList');
        const tempFileCount = document.getElementById('tempFileCount');
        const outputFileCount = document.getElementById('outputFileCount');
        const moveToDoneBtn = document.getElementById('moveToDoneBtn');
        const selectedCount = document.getElementById('selectedCount');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioElement = document.getElementById('audioElement');
        const audioPlayerTitle = document.getElementById('audioPlayerTitle');
        const themeToggle = document.getElementById('themeToggle');
        const previewBox = document.getElementById('previewBox');
        const previewContent = document.getElementById('previewContent');
        const urlInput = document.getElementById('url');

        let currentPlayingFile = null;
        let currentPlayingLocation = null;
        let selectedFiles = new Set();
        let outputFilesVisible = false;
        let previewTimeout = null;

        // Cookie functions
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length);
            }
            return null;
        }

        // Icon helper functions
        function getSunIcon() {
            return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>';
        }

        function getMoonIcon() {
            return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>';
        }

        function getMusicIcon() {
            return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>';
        }

        function getPlayIcon() {
            return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        function getPauseIcon() {
            return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        function getTrashIcon() {
            return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
        }

        function getPlaylistIcon() {
            return '<svg class="w-3 h-3 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>';
        }

        function getCheckCircleIcon() {
            return '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        function getXCircleIcon() {
            return '<svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        function getLinkIcon() {
            return '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-5.656-3.828l1.102-1.101m0 0l4 4m-4-4l4 4"></path></svg>';
        }

        function getClockIcon() {
            return '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        function getCheckCircleIconSmall() {
            return '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }

        // Theme handling
        function setTheme(theme) {
            if (theme === 'light') {
                document.documentElement.classList.remove('dark');
                themeToggle.innerHTML = getSunIcon();
                themeToggle.title = 'Switch to dark mode';
            } else {
                document.documentElement.classList.add('dark');
                themeToggle.innerHTML = getMoonIcon();
                themeToggle.title = 'Switch to light mode';
            }
            setCookie('theme', theme, 365);
        }

        // Load saved theme or default to dark
        const savedTheme = getCookie('theme');
        if (savedTheme === 'light') {
            setTheme('light');
        }

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Audio player event listeners
        audioElement.addEventListener('ended', updatePlayButtons);
        audioElement.addEventListener('pause', updatePlayButtons);
        audioElement.addEventListener('play', updatePlayButtons);

        // Move to Done button
        moveToDoneBtn.addEventListener('click', moveToDone);

        // Refresh buttons
        const refreshTempBtn = document.getElementById('refreshTempBtn');
        const refreshOutputBtn = document.getElementById('refreshOutputBtn');
        
        refreshTempBtn.addEventListener('click', () => {
            loadFiles();
        });
        
        refreshOutputBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            loadFiles();
        });

        // Output section toggle for mobile
        function toggleOutputSection() {
            // Only toggle on mobile (screen width < 1024px)
            if (window.innerWidth < 1024) {
                const outputFileList = document.getElementById('outputFileList');
                const outputChevron = document.getElementById('outputChevron');
                outputFileList.classList.toggle('hidden');
                outputChevron.classList.toggle('rotate-180');
            }
        }

        // Set initial state: collapsed on mobile, expanded on desktop
        function setOutputInitialState() {
            const outputFileList = document.getElementById('outputFileList');
            const outputChevron = document.getElementById('outputChevron');
            const isMobile = window.innerWidth < 1024; // lg breakpoint
            
            if (isMobile) {
                outputFileList.classList.add('hidden');
                outputChevron.classList.remove('rotate-180');
            } else {
                outputFileList.classList.remove('hidden');
                outputChevron.classList.add('rotate-180');
            }
        }

        // Set initial state on load
        setOutputInitialState();

        // Update on resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const outputFileList = document.getElementById('outputFileList');
                const isMobile = window.innerWidth < 1024;
                if (isMobile && !outputFileList.classList.contains('hidden')) {
                    // Don't auto-collapse if user has manually expanded it
                    // Only set initial state if it's still in default state
                }
            }, 250);
        });

        // Load files on page load
        loadFiles();
        setInterval(loadFiles, 5000);

        // Load and restore speed setting from cookie
        function loadSpeedSetting() {
            const savedSpeed = getCookie('speed') || '1';
            const speedRadio = document.querySelector(`input[name="speed"][value="${savedSpeed}"]`);
            if (speedRadio) {
                speedRadio.checked = true;
            }
        }

        // Save speed setting to cookie when changed
        document.querySelectorAll('input[name="speed"]').forEach(radio => {
            radio.addEventListener('change', function() {
                setCookie('speed', this.value, 365);
            });
        });

        // Load saved speed on page load
        loadSpeedSetting();

        // Preview on URL input
        urlInput.addEventListener('input', function() {
            clearTimeout(previewTimeout);
            const url = this.value.trim();
            
            if (url && (url.includes('youtube.com') || url.includes('youtu.be'))) {
                previewTimeout = setTimeout(() => loadPreview(url), 800);
            } else {
                previewBox.classList.add('hidden');
            }
        });

        async function loadPreview(url) {
            try {
                previewBox.classList.remove('hidden');
                previewContent.innerHTML = '<div class="text-xs text-stone-500 dark:text-stone-400 text-center py-2">Loading preview...</div>';
                
                const response = await fetch('/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    previewContent.innerHTML = `<div class="text-xs text-red-600 dark:text-red-400">${data.error}</div>`;
                    return;
                }
                
                if (data.type === 'playlist') {
                    previewContent.innerHTML = `
                        <div class="flex gap-3">
                            ${data.thumbnail ? `<img src="${data.thumbnail}" alt="" class="w-16 h-16 rounded object-cover flex-shrink-0 border border-stone-200 dark:border-stone-600">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-semibold text-stone-900 dark:text-stone-50 mb-1 line-clamp-2">${escapeHtml(data.title)}</div>
                                <div class="text-[10px] text-stone-600 dark:text-stone-400">${getPlaylistIcon()} Playlist ‚Ä¢ ${data.count} videos</div>
                            </div>
                        </div>
                    `;
                } else {
                    const duration = data.duration ? formatDuration(data.duration) : '';
                    previewContent.innerHTML = `
                        <div class="flex gap-3">
                            ${data.thumbnail ? `<img src="${data.thumbnail}" alt="" class="w-16 h-16 rounded object-cover flex-shrink-0 border border-stone-200 dark:border-stone-600">` : ''}
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-semibold text-stone-900 dark:text-stone-50 mb-1 line-clamp-2">${escapeHtml(data.title)}</div>
                                <div class="text-[10px] text-stone-600 dark:text-stone-400">${escapeHtml(data.uploader)}${duration ? ' ‚Ä¢ ' + duration : ''}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Preview error:', error);
                previewBox.classList.add('hidden');
            }
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }



        function toggleSelectAll(isChecked) {
            selectedFiles.clear();
            document.querySelectorAll('input[type="checkbox"][data-filename]').forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    selectedFiles.add(checkbox.dataset.filename);
                }
            });
            updateSelectionUI();
        }

        function toggleFileSelection(filename, isChecked) {
            if (isChecked) {
                selectedFiles.add(filename);
            } else {
                selectedFiles.delete(filename);
                // Uncheck select all if exists
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
            }
            updateSelectionUI();
        }

        function updateSelectionUI() {
            selectedCount.textContent = selectedFiles.size;
            moveToDoneBtn.classList.toggle('hidden', selectedFiles.size === 0);
        }

        async function moveToDone() {
            if (selectedFiles.size === 0) return;

            moveToDoneBtn.disabled = true;
            const filesToMove = Array.from(selectedFiles);

            try {
                const response = await fetch('/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filenames: filesToMove })
                });

                const data = await response.json();

                if (response.ok) {
                    selectedFiles.clear();
                    updateSelectionUI();
                    loadFiles();
                    
                    if (data.errors && data.errors.length > 0) {
                        alert(`Moved ${data.moved} file(s). Errors:\n${data.errors.join('\n')}`);
                    }
                } else {
                    alert('Failed to move files: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error moving files:', error);
                alert('Error moving files');
            } finally {
                moveToDoneBtn.disabled = false;
            }
        }

        async function loadFiles() {
            try {
                const response = await fetch('/files');
                const data = await response.json();
                
                // Load temp files
                if (data.temp_files && data.temp_files.length > 0) {
                    tempFileCount.textContent = data.temp_files.length;
                    const hasMultipleFiles = data.temp_files.length > 1;
                    tempFileList.innerHTML = `
                        ${hasMultipleFiles ? `
                        <div class="p-3 border-b border-stone-200 dark:border-stone-700 bg-stone-50 dark:bg-stone-700/30">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)" class="w-4 h-4 rounded" style="appearance: auto;">
                                <span class="text-xs font-semibold text-stone-700 dark:text-stone-300">Select All</span>
                            </label>
                        </div>
                        ` : ''}
                        ${data.temp_files.map(file => renderFileItem(file, true)).join('')}
                    `;
                    updatePlayButtons();
                } else {
                    tempFileCount.textContent = '0';
                    selectedFiles.clear();
                    updateSelectionUI();
                    tempFileList.innerHTML = `
                        <div class="text-center py-12 text-stone-500 dark:text-stone-400">
                            <div class="text-4xl mb-2">üìÇ</div>
                            <div class="text-sm">No files yet</div>
                        </div>
                    `;
                }

                // Load output files
                if (data.output_files && data.output_files.length > 0) {
                    outputFileCount.textContent = data.output_files.length;
                    outputFileList.innerHTML = data.output_files.map(file => renderFileItem(file, false)).join('');
                    updatePlayButtons();
                } else {
                    outputFileCount.textContent = '0';
                    outputFileList.innerHTML = `
                        <div class="text-center py-12 text-stone-500 dark:text-stone-400">
                            <div class="text-4xl mb-2">üìÅ</div>
                            <div class="text-sm">Empty</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function renderFileItem(file, showCheckbox) {
            const escapedName = escapeHtml(file.name);
            const escapedNameForJs = escapeHtml(file.name).replace(/'/g, "\\'");
            const thumbnail = file.has_thumbnail ? 
                `<img src="/thumbnail/${file.location}/${encodeURIComponent(file.name)}" alt="" class="w-10 h-10 rounded object-cover flex-shrink-0 border border-stone-200 dark:border-stone-600" onerror="this.style.display='none'">` :
                `<div class="w-10 h-10 rounded bg-gradient-to-br from-stone-300 to-stone-400 dark:from-stone-600 dark:to-stone-700 flex items-center justify-center flex-shrink-0">${getMusicIcon()}</div>`;

            return `
                <div class="flex items-center gap-2 p-3 border-b border-stone-200 dark:border-stone-700 hover:bg-stone-50 dark:hover:bg-stone-700/30 transition-colors">
                    ${showCheckbox ? `<input type="checkbox" data-filename="${escapedName}" onchange="toggleFileSelection('${escapedNameForJs}', this.checked)" ${selectedFiles.has(file.name) ? 'checked' : ''} class="w-4 h-4 rounded flex-shrink-0" style="appearance: auto;">` : ''}
                    ${thumbnail}
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium text-stone-900 dark:text-stone-50 truncate" title="${escapedName}">${escapedName}</div>
                        <div class="text-[10px] text-stone-600 dark:text-stone-400">${file.size} MB</div>
                    </div>
                    <div class="flex gap-1">
                        <button class="w-7 h-7 flex items-center justify-center rounded hover:bg-stone-200 dark:hover:bg-stone-600 play-btn" id="play-${file.location}-${escapedName}" onclick="togglePlay('${file.location}', '${escapedNameForJs}')">${getPlayIcon()}</button>
                        ${file.location === 'temp' ? `<button class="w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-900/20 text-red-600" onclick="deleteFile('${file.location}', '${escapedNameForJs}')">${getTrashIcon()}</button>` : ''}
                    </div>
                </div>
            `;
        }

        function togglePlay(location, filename) {
            if (currentPlayingFile === filename && currentPlayingLocation === location && !audioElement.paused) {
                audioElement.pause();
            } else {
                if (currentPlayingFile !== filename || currentPlayingLocation !== location) {
                    currentPlayingFile = filename;
                    currentPlayingLocation = location;
                    audioElement.src = `/stream/${location}/${encodeURIComponent(filename)}`;
                    audioPlayerTitle.textContent = filename;
                    audioPlayer.classList.remove('hidden');
                }
                audioElement.play();
            }
            updatePlayButtons();
        }

        function closeAudioPlayer() {
            audioElement.pause();
            audioPlayer.classList.add('hidden');
            currentPlayingFile = null;
            currentPlayingLocation = null;
            updatePlayButtons();
        }

        function updatePlayButtons() {
            document.querySelectorAll('.play-btn').forEach(btn => {
                const [, location, ...nameParts] = btn.id.split('-');
                const filename = nameParts.join('-');
                if (filename === currentPlayingFile && location === currentPlayingLocation && !audioElement.paused) {
                    btn.innerHTML = getPauseIcon();
                    btn.classList.add('bg-stone-900', 'dark:bg-stone-200', 'text-white', 'dark:text-stone-900');
                } else {
                    btn.innerHTML = getPlayIcon();
                    btn.classList.remove('bg-stone-900', 'dark:bg-stone-200', 'text-white', 'dark:text-stone-900');
                }
            });
        }

        async function deleteFile(location, filename) {
            if (!confirm(`Delete "${filename}"?`)) return;

            try {
                if (currentPlayingFile === filename && currentPlayingLocation === location) {
                    closeAudioPlayer();
                }

                const response = await fetch(`/delete/${location}/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    selectedFiles.delete(filename);
                    updateSelectionUI();
                    loadFiles();
                } else {
                    alert('Failed to delete file');
                }
            } catch (error) {
                console.error('Error deleting file:', error);
                alert('Error deleting file');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const url = document.getElementById('url').value;
            const speed = document.querySelector('input[name="speed"]:checked').value;

            // Show status box
            statusBox.classList.remove('hidden', 'border-green-500', 'dark:border-green-400', 'border-red-500', 'dark:border-red-400', 'border-stone-400', 'dark:border-stone-500');
            statusBox.classList.add('border-stone-400', 'dark:border-stone-500', 'bg-stone-100', 'dark:bg-stone-700/50');
            statusTitle.textContent = 'Processing...';
            statusMessage.textContent = 'Starting download...';
            progressFill.style.width = '0%';
            downloadBtn.disabled = true;

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, speed: parseFloat(speed) }),
                });

                const data = await response.json();

                if (response.ok) {
                    const downloadId = data.download_id;
                    
                    const pollInterval = setInterval(async () => {
                        const statusResponse = await fetch(`/status/${downloadId}`);
                        const statusData = await statusResponse.json();

                        statusMessage.textContent = statusData.message;

                        if (statusData.progress) {
                            const progressValue = parseFloat(statusData.progress);
                            if (!isNaN(progressValue)) {
                                progressFill.style.width = progressValue + '%';
                            }
                        }

                        if (statusData.status === 'completed') {
                            clearInterval(pollInterval);
                            statusBox.classList.remove('border-stone-400', 'dark:border-stone-500', 'bg-stone-100', 'dark:bg-stone-700/50');
                            statusBox.classList.add('border-green-500', 'dark:border-green-400', 'bg-green-50', 'dark:bg-green-900/20');
                            statusTitle.innerHTML = getCheckCircleIcon() + ' Success!';
                            progressFill.style.width = '100%';
                            downloadBtn.disabled = false;
                            loadFiles();
                            
                            setTimeout(() => {
                                // Only clear the URL field, keep speed setting
                                document.getElementById('url').value = '';
                                statusBox.classList.add('hidden');
                            }, 5000);
                        } else if (statusData.status === 'error') {
                            clearInterval(pollInterval);
                            statusBox.classList.remove('border-stone-400', 'dark:border-stone-500', 'bg-stone-100', 'dark:bg-stone-700/50');
                            statusBox.classList.add('border-red-500', 'dark:border-red-400', 'bg-red-50', 'dark:bg-red-900/20');
                            statusTitle.innerHTML = getXCircleIcon() + ' Error';
                            downloadBtn.disabled = false;
                        }
                    }, 1000);
                } else {
                    statusBox.classList.remove('border-stone-400', 'dark:border-stone-500', 'bg-stone-100', 'dark:bg-stone-700/50');
                    statusBox.classList.add('border-red-500', 'dark:border-red-400', 'bg-red-50', 'dark:bg-red-900/20');
                    statusTitle.innerHTML = getXCircleIcon() + ' Error';
                    statusMessage.textContent = data.error || 'An error occurred';
                    downloadBtn.disabled = false;
                }
            } catch (error) {
                statusBox.classList.remove('border-stone-400', 'dark:border-stone-500', 'bg-stone-100', 'dark:bg-stone-700/50');
                statusBox.classList.add('border-red-500', 'dark:border-red-400', 'bg-red-50', 'dark:bg-red-900/20');
                statusTitle.innerHTML = getXCircleIcon() + ' Error';
                statusMessage.textContent = 'Failed to connect to server';
                downloadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
